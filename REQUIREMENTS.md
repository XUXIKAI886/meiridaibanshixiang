# 📋 日拱一足 - 云端同步需求文档

## 🎯 项目概述

将"日拱一足"修身应用从本地存储升级为云端同步，实现跨设备数据访问和自动备份功能。

## 📊 现状分析

### 当前实现
- ✅ 本地localStorage存储
- ✅ 每日自动重置功能
- ✅ 习惯的隐藏/恢复机制
- ❌ 数据仅限单设备访问
- ❌ 无数据备份机制
- ❌ 无跨设备同步

### 存在问题
1. **数据孤岛**: 每台设备的数据独立，无法同步
2. **数据丢失风险**: 浏览器数据清理会导致数据永久丢失
3. **使用局限**: 用户只能在固定设备上管理习惯
4. **无备份**: 没有数据备份和恢复机制

## 🎯 核心需求

### 功能需求

#### 1. 云端数据存储
- **需求**: 将待办事项数据存储到GitHub私有仓库
- **目标**: 替代localStorage，实现持久化云端存储
- **数据格式**: JSON格式存储习惯数据
- **存储位置**: GitHub私有仓库的`data`分支或`data.json`文件

#### 2. 跨设备同步
- **需求**: 在任何设备上访问相同的习惯数据
- **场景**: 
  - 家里电脑添加习惯，公司电脑能看到
  - 手机浏览器也能同步访问
  - 多设备状态实时同步
- **同步时机**: 
  - 页面加载时自动拉取最新数据
  - 数据修改后自动推送到云端
  - 定时同步检查更新

#### 3. 数据备份与恢复
- **需求**: 自动备份用户数据，支持历史版本恢复
- **备份策略**: 
  - 每次修改自动备份
  - 保留最近30天的历史版本
  - 支持手动导入/导出数据

#### 4. 离线支持
- **需求**: 网络异常时应用仍可正常使用
- **实现**: 
  - 本地缓存 + 云端同步的混合模式
  - 网络恢复后自动同步冲突解决
  - 离线状态提示

### 技术需求

#### 1. GitHub集成
- **API使用**: GitHub REST API v4
- **认证方式**: Personal Access Token
- **权限要求**: 
  - `repo` - 仓库读写权限
  - `user` - 用户信息读取权限
- **仓库配置**: 
  - 私有仓库确保数据安全
  - 合理的分支策略
  - 自动化备份机制

#### 2. 安全性要求
- **令牌安全**: 
  - 不在前端代码中硬编码令牌
  - 使用环境变量或安全的配置方式
  - 令牌权限最小化原则
- **数据加密**: 
  - 敏感数据客户端加密
  - 传输过程使用HTTPS
- **访问控制**: 
  - 仅授权用户可访问数据
  - 支持令牌撤销和更新

#### 3. 性能要求
- **响应时间**: 
  - 数据加载 < 2秒
  - 数据保存 < 1秒
  - 同步延迟 < 5秒
- **数据量**: 
  - 支持1000+习惯项目
  - 历史数据保留1年
- **网络优化**: 
  - 增量同步减少数据传输
  - 压缩数据减少带宽使用

## 🏗️ 技术架构

### 数据流架构
```
用户操作 → 本地缓存 → GitHub API → 私有仓库
    ↑                                      ↓
    ← 同步检查 ← 定时任务 ← 数据拉取 ←
```

### 存储结构设计
```json
{
  "version": "1.0",
  "lastSync": "2024-01-01T00:00:00Z",
  "lastResetDate": "2024-01-01",
  "habits": [
    {
      "id": "habit_1",
      "text": "早起",
      "completed": false,
      "hidden": false,
      "createdAt": "2024-01-01T00:00:00Z",
      "updatedAt": "2024-01-01T00:00:00Z"
    }
  ],
  "settings": {
    "theme": "light",
    "autoSync": true,
    "syncInterval": 300000
  }
}
```

### API设计
```typescript
interface SyncService {
  // 数据同步
  sync(): Promise<SyncResult>
  push(data: HabitsData): Promise<void>
  pull(): Promise<HabitsData>
  
  // 冲突解决
  resolveConflict(local: HabitsData, remote: HabitsData): HabitsData
  
  // 备份管理
  backup(): Promise<string>
  restore(backupId: string): Promise<HabitsData>
  getBackupHistory(): Promise<BackupInfo[]>
}
```

## 🎨 用户体验设计

### 1. 初次使用设置
- **配置向导**: 引导用户设置GitHub集成
- **数据迁移**: 自动迁移localStorage数据到云端
- **权限说明**: 清楚说明所需GitHub权限

### 2. 同步状态显示
- **同步指示器**: 实时显示同步状态
- **网络状态**: 显示在线/离线状态
- **最后同步时间**: 显示数据最后更新时间

### 3. 冲突处理UI
- **冲突提示**: 当检测到数据冲突时的友好提示
- **版本选择**: 让用户选择保留哪个版本的数据
- **合并选项**: 提供智能合并建议

## 🚀 实施计划

### 第一阶段：基础同步功能 (1-2天)
1. ✅ 创建私有GitHub仓库
2. ✅ 实现GitHub API集成
3. ✅ 基础数据读写功能
4. ✅ 替换localStorage为云端存储

### 第二阶段：同步优化 (1天)
1. ⭕ 实现增量同步
2. ⭕ 添加冲突检测和解决
3. ⭕ 离线模式支持
4. ⭕ 同步状态UI

### 第三阶段：安全加固 (1天)
1. ⭕ 实现安全的令牌管理
2. ⭕ 添加数据加密
3. ⭕ 访问权限控制
4. ⭕ 安全审计日志

### 第四阶段：用户体验优化 (1天)
1. ⭕ 配置向导界面
2. ⭕ 备份恢复功能
3. ⭕ 数据导入导出
4. ⭕ 同步历史查看

## ⚠️ 风险与挑战

### 技术风险
1. **API限制**: GitHub API有速率限制，需要合理控制请求频率
2. **网络依赖**: 网络不稳定可能影响用户体验
3. **数据冲突**: 多设备同时操作可能导致数据冲突

### 安全风险
1. **令牌泄露**: 访问令牌泄露可能导致数据被恶意访问
2. **数据隐私**: 需要确保用户数据的隐私和安全
3. **权限滥用**: 过度的权限可能带来安全隐患

### 用户体验风险
1. **学习成本**: 用户需要学会GitHub集成设置
2. **依赖性**: 用户变得依赖GitHub服务的可用性
3. **兼容性**: 不同浏览器的兼容性问题

## 📈 成功指标

### 功能指标
- ✅ 跨设备数据同步成功率 > 99%
- ✅ 数据同步延迟 < 5秒
- ✅ 离线模式可用性 > 95%

### 用户体验指标  
- ✅ 用户设置成功率 > 90%
- ✅ 数据丢失事件 = 0
- ✅ 用户满意度评分 > 4.5/5

### 技术指标
- ✅ API调用成功率 > 99.5%
- ✅ 系统可用性 > 99.9%
- ✅ 安全事件 = 0

## 🔄 后续规划

### 短期优化 (1-3个月)
- 支持更多云端存储选项 (Dropbox, OneDrive)
- 实现团队协作功能
- 添加习惯统计和分析

### 长期发展 (3-12个月)
- 移动端原生应用
- 智能提醒系统
- 社交分享功能
- AI驱动的习惯建议

---

**文档版本**: 1.0  
**创建日期**: 2024年1月  
**负责人**: 开发团队  
**审核状态**: 待审核
